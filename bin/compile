#!/usr/bin/env bash

# Ensure wildcards in globs match dotfiles too.
shopt -s dotglob

indent() {
    sed -u 's/^/      /'
}

BUILD_DIR="$1"
CACHE_DIR="$2"
ENV_DIR="$3"

if [ ! -f "${ENV_DIR}/APP_BASE" ]; then
    echo "APP_BASE was not set. Aborting"
    exit 1
fi
APP_BASE="$(cat "${ENV_DIR}/APP_BASE")"
APP_DIR="$BUILD_DIR/$APP_BASE"

copy() {
  
  # Heroku specific?
  if [[ -f "$1.heroku" ]]; then 

    echo "Copying $1.heroku to $BUILD_DIR/$(basename "$1.heroku" .heroku)" | indent
    cp "$1.heroku" "$BUILD_DIR/$(basename "$1.heroku" .heroku)"

  elif [[ -f "$1" ]]; then 

    echo "Copying $1 to $BUILD_DIR" | indent
    cp "$1" "$BUILD_DIR/"

  fi
}

copy "$APP_DIR/requirements.txt"
copy "$APP_DIR/package.json"
copy "$APP_DIR/package-lock.json"
copy "$APP_DIR/yarn.lock"
copy "$APP_DIR/Gemfile"
copy "$APP_DIR/Gemfile.lock"
copy "$APP_DIR/app.json"
copy "$APP_DIR/Procfile"
